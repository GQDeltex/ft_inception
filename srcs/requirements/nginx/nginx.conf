worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include conf/mime.types;
    index   index.html index.htm;

    default_type    application/octet-stream;
    access_log      /dev/stdout;
    error_log       /dev/stdout;
    sendfile        on;
    tcp_nopush      on;
    server_names_hash_bucket_size   128; # this seems to be required for some vhosts

    server { # php/fastcgi
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name {{ DOMAIN }};
        root        /var/www/html;
        index       index.html index.htm index.php;

        # Config generated by https://ssl-config.mozilla.org/
        ssl_certificate /etc/nginx/certs/cert.crt;
        ssl_certificate_key /etc/nginx/certs/cert.key;
        ssl_session_timeout 1d;
        ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions
        ssl_session_tickets off;
        # modern configuration
        ssl_protocols TLSv1.3;
        ssl_prefer_server_ciphers off;
        # HSTS (ngx_http_headers_module is required) (63072000 seconds)
        add_header Strict-Transport-Security "max-age=63072000" always;

        location ~ [^/]\.php(/|$) {
            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
            if (!-f $document_root$fastcgi_script_name) {
                return 404;
            }

            # Mitigate https://httpoxy.org/ vulnerabilities
            fastcgi_param HTTP_PROXY "";

            fastcgi_pass wordpress:9000;
            fastcgi_index index.php;

            # include the fastcgi_param setting
            include fastcgi_params;

            fastcgi_param  SCRIPT_FILENAME   $document_root$fastcgi_script_name;
        }
    }
}
